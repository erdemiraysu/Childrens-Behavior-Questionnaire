---
title: "CBQ_04.23.24_Gather_Clean"
output: html_document
date: "2024-04-23"
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
library(dplyr)
library(tidyr)
library(lubridate) # for working with datetime
```
# CREATE A FUNCTION TO CALCULATE TALKERGROUP BASED ON SLD AND SSI SCORES
# Talkergroup = 1 is CWS, Talkergroup = 0 is CWNS, 
```{r}

calculate_talkergroup <- function(data, sld_col, ssi_col) {
  data %>%
    mutate(talkergroup_calculated = ifelse({{sld_col}}>= 3 | {{ssi_col}} >= 11, 1,
                                           ifelse({{sld_col}} < 3 & {{ssi_col}} < 11, 0, 9)))
}

```

#####################################################################################################
#OLD DATASET ########################################################################################
#####################################################################################################

# Load and merge intake with survey data
# Calculate talkergroup
# Calculate age in months using birth date and visit date
# Select only the relevant columns
# Drop mostly empty rows
```{r}
# Load DataSet: 
intake_2000 <- read.csv(file = '/Users/aysuerdemir/Desktop/CBQ_EDA/Data/Oldest_INTAKE_2001-2008.csv')
cbq_2000 <- read.csv(file = '/Users/aysuerdemir/Desktop/CBQ_EDA/Data/Oldest_CBQ_2001-2008.csv')

# Merge the two using LabCode
Full_2000 <- merge(cbq_2000, intake_2000, by=c("LabCode"), all.x = TRUE)

# Calculate talkergroup by creating a new column "talkergroup_calculated" using the pre-defined function
Full_2000 <- calculate_talkergroup(Full_2000, sldavg, ssi3freq) # Full_2000 <- Full_2000 %>%

# Calculate age in months using birth date and visit date:
# Convert 'dob' and 'dov1' to date time (assuming month-day-year format)
Full_2000$dob <- mdy(Full_2000$dob)
Full_2000$dov1 <- mdy(Full_2000$dov1)

# Calculate age in months using days and ensure it appears as numeric
Full_2000$age_calculated <- as.numeric(round(difftime(Full_2000$dov1, Full_2000$dob, units = "days") / 30.4375))

# Select only the relevant columns using dplyr::select - subset function does not support mixing column names and column ranges
Full_2000 <- Full_2000 %>% 
  dplyr::select(LabCode,dob, dov1, age_calculated, gender, sldavg, ssi3freq, sldgrp, ssi3grp, group,talkergroup_calculated, ncbq0001:ncbq0195)

# Replace all empty strings with NA in the dataset before dropping
Full_2000 <- replace(Full_2000, Full_2000 == "", NA)

# Filter rows with less than 20 missing values in columns cbq0001 to cbq0195
Full_2000 <- Full_2000 %>%
  filter(rowSums(is.na(select(., ncbq0001:ncbq0195))) < 20)

print(nrow(Full_2000))
```

#####################################################################################################
#LONGITUDINAL DATASET ###############################################################################
#####################################################################################################

# Load and merge intake with survey data
# Calculate talkergroup
# Calculate age in months using birth date and visit date
# Select only the relevant columns
# Drop mostly empty rows

```{r}

# Load DataSet Intake: 
intake_2010 <- read.csv(file = '/Users/aysuerdemir/Desktop/CBQ_EDA/Data/Longi_INTAKE_2010-2016.csv')
# Work with only the CVD portion, excluding CVJ and surveys since the file is large
intake_2010 <- intake_2010 %>% 
  dplyr::select(participant_id:c_v_d_complete)

# Load DataSet CBQ: 
cbq_2010 <- read.csv(file = '/Users/aysuerdemir/Desktop/CBQ_EDA/Data/Longi_CBQ_2007-2016.csv')

# Merge the two using participant_id, while taking survey - CBQ data as primary
Full_2010 <- merge(cbq_2010, intake_2010, by=c("participant_id"), all.x = TRUE)

# Calculate talkergroup by creating a new column "talkergroup_calculated" using the pre-defined function
Full_2010 <- calculate_talkergroup(Full_2010, disfluency_sldper100words, ssi_total) # Full_2000 <- Full_2000 %>%

# Calculate age in months using birth date and visit date:
# Convert 'dob' and 'dov1' to date time (assuming month-day-year format)
Full_2010$date_birth <- mdy(Full_2010$date_birth)
Full_2010$cvd_date <- mdy(Full_2010$cvd_date)

# Calculate age in months using days and ensure it appears as numeric
Full_2010$age_calculated <- as.numeric(round(difftime(Full_2010$cvd_date, Full_2010$date_birth, units = "days") / 30.4375))

# Select only the relevant columns using dplyr::select - subset function does not support mixing column names and column ranges
Full_2010 <- Full_2010 %>% 
  dplyr::select(participant_id, date_birth, cvd_date, age_cvd, age_calculated, calculator_gender1, disfluency_sldper100words, ssi_total, talkergroup_disfluency, talker_group_phone,talkergroup_calculated ,cbq0001:cbq0195)

# Replace all empty strings with NA in the dataset before dropping
Full_2010 <- replace(Full_2010, Full_2010 == "", NA)

# Filter rows with less than 20 missing values in columns cbq0001 to cbq0195
Full_2010 <- Full_2010 %>%
  filter(rowSums(is.na(select(., cbq0001:cbq0195))) < 20)

print(nrow(Full_2010))

```

#####################################################################################################
# LONGITUDINAL PILOT DATASET ########################################################################
#####################################################################################################
# KEEP ONLY THE PILOT KIDS SINCE THIS DATAFRAME OVERLAPS WITH LONGITUDINAL DATASET ##################
#####################################################################################################

```{r}

# Load DataSet: 
Full_2007 <- read.csv(file = '/Users/aysuerdemir/Desktop/CBQ_EDA/Data/LongiPilot_CBQ_INTAKE_2007-2009.csv')

# Extract unique subjects from both this dataset and the longitudinal dataset (take intake since it was more comprehensive)
subjects_2007 <- unique(Full_2007$participant_id)
subjects_2010 <- unique(intake_2010$participant_id)

# Find subjects that are unique to 2007 dataset
unique_subjects_2007 <- setdiff(subjects_2007, subjects_2010)

# Subset this dataset to include only subjects in unique_subjects_2007
Full_2007 <- subset(Full_2007, participant_id %in% unique_subjects_2007)

# Calculate talkergroup by creating a new column "talkergroup_calculated" using the pre-defined function
Full_2007 <- calculate_talkergroup(Full_2007, disfluency_sldper100words, ssi_total) 

# Calculate age in months using birth date and visit date:
# Convert 'dob' and 'dov1' to date time (this dataset is in year-month-day format)
Full_2007$date_birth <- ymd(Full_2007$date_birth)
Full_2007$cvd_date <- ymd(Full_2007$cvd_date)

# Calculate age in months using days and ensure it appears as numeric
Full_2007$age_calculated <- as.numeric(round(difftime(Full_2007$cvd_date, Full_2007$date_birth, units = "days") / 30.4375))

# Select only the relevant columns using dplyr::select - subset function does not support mixing column names and column ranges
Full_2007 <- Full_2007 %>% 
  dplyr::select(participant_id, date_birth, cvd_date, age_calculated, calculator_gender1, disfluency_sldper100words, ssi_total, talkergroup_calculated, cbq0001:cbq0195)

# Replace all empty strings with NA in the dataset before dropping
Full_2007 <- replace(Full_2007, Full_2007 == "", NA)

# Filter rows with less than 20 missing values in columns cbq0001 to cbq0195
Full_2007 <- Full_2007 %>%
  filter(rowSums(is.na(select(., cbq0001:cbq0195))) < 20)

print(nrow(Full_2007))

```


#####################################################################################################
#COG_EMO_LIN DATASET ################################################################################
#####################################################################################################

```{r}
# Load DataSet: 
Full_2016 <- read.csv(file = '/Users/aysuerdemir/Desktop/CBQ_EDA/Data/CogEmoLin_CBQ_INTAKE_after2016.csv')

# Calculate talkergroup by creating a new column "talkergroup_calculated" using the pre-defined function
Full_2016 <- calculate_talkergroup(Full_2016, disfluency_sldper100words, ssi_total) 

# Calculate age in months using birth date and visit date:
# Convert 'dob' and 'dov1' to date time (this dataset is in year-month-day format)
Full_2016$date_birth <- ymd(Full_2016$date_birth)
Full_2016$cvd_date <- ymd(Full_2016$cvd_date)

# Calculate age in months using days and ensure it appears as numeric
Full_2016$age_calculated <- as.numeric(round(difftime(Full_2016$cvd_date, Full_2016$date_birth, units = "days") / 30.4375))

# Select only the relevant columns using dplyr::select - subset function does not support mixing column names and column ranges
Full_2016 <- Full_2016 %>% 
  dplyr::select(part_id_status, date_birth, cvd_date, age_cvd, age_calculated, gender, disfluency_sldper100words, ssi_total, talkergroup_disfluency_cvd, talkergroup_ssi_cvd, talker_group_parent, talkergroup_calculated, cbq0001:cbq0195)

# Replace all empty strings with NA in the dataset before dropping
Full_2016 <- replace(Full_2016, Full_2016 == "", NA)

# Filter rows with less than 20 missing values in columns cbq0001 to cbq0195
Full_2016 <- Full_2016 %>%
  filter(rowSums(is.na(select(., cbq0001:cbq0195))) < 20)

print(nrow(Full_2016))

```


#####################################################################################################
#COMBINED DATASET ###################################################################################
#####################################################################################################


# RENAME COLUMNS FOR Full_2000
```{r}

# RENAME COLUMNS FOR Full_2000

# Print col names
print(colnames(Full_2000))

# For CBQ related columns:

# Get the column names to be renamed
old_column_names <- names(Full_2000)[grep("^ncbq", names(Full_2000))]
# Generate the new column names without 'n'
new_column_names <- gsub("^n", "", old_column_names)
# Rename the columns
names(Full_2000)[grep("^ncbq", names(Full_2000))] <- new_column_names

# Other columns to rename:
Full_2000 <- Full_2000 %>%
  rename(subject = LabCode,
         age = age_calculated,
         gender = gender,
         sld = sldavg,
         ssi = ssi3freq,
         talkergroup = talkergroup_calculated)

# Filter dataset
Full_2000 <- Full_2000 %>% 
  dplyr::select(subject, age, gender, sld, ssi, talkergroup, cbq0001:cbq0195)

```

# RENAME COLUMNS FOR Full_2007
```{r}

# Print col names
print(colnames(Full_2007))

# Rename columns:
Full_2007 <- Full_2007 %>%
  rename(subject = participant_id,
         age = age_calculated,
         gender = calculator_gender1,
         sld = disfluency_sldper100words,
         ssi = ssi_total,
         talkergroup = talkergroup_calculated)

# Filter dataset
Full_2007 <- Full_2007 %>% 
  dplyr::select(subject, age, gender, sld, ssi, talkergroup, cbq0001:cbq0195)

```

# RENAME COLUMNS FOR Full_2010
```{r}
# Print col names
print(colnames(Full_2010))

# Rename columns:
Full_2010 <- Full_2010 %>%
  rename(subject = participant_id,
         age = age_calculated,
         gender = calculator_gender1,
         sld = disfluency_sldper100words,
         ssi = ssi_total,
         talkergroup = talkergroup_calculated)

# Filter dataset
Full_2010 <- Full_2010 %>% 
  dplyr::select(subject, age, gender, sld, ssi, talkergroup, cbq0001:cbq0195)

```

# RENAME COLUMNS FOR Full_2016
```{r}

# Print col names
print(colnames(Full_2016))

# Rename columns:
Full_2016 <- Full_2016 %>%
  rename(subject = part_id_status,
         age = age_calculated,
         gender = gender,
         sld = disfluency_sldper100words,
         ssi = ssi_total,
         talkergroup = talkergroup_calculated)

# Filter dataset
Full_2016 <- Full_2016 %>% 
  dplyr::select(subject, age, gender, sld, ssi, talkergroup, cbq0001:cbq0195)

```


#################################
#####MERGE ALL###################
#################################


```{r}

# Check for overlapping Subject IDs

# FOR THESE PRIORITIZE THE Full_2010 dataset
overlap_check1 <- intersect(Full_2000$subject, Full_2007$subject)

# FOR THESE PRIORITIZE THE Full_2010 dataset
overlap_check2 <- intersect(Full_2000$subject, Full_2010$subject)

# FOR THESE PILOT KIDS PRIORITIZE THE Full_2007 dataset because it has more more data
overlap_check3 <- intersect(Full_2007$subject, Full_2010$subject)

overlap_check4 <- intersect(Full_2010$subject, Full_2016$subject)
# character(0)

print(overlap_check1)
print(overlap_check2)
print(overlap_check3)
print(overlap_check4)

```

# MERGE THE DATASETS

# Stack Full_2007 and Full_2010
```{r}
# Stack Full_2007 and Full_2010, Full_2007 comes first
Stacked_2007_2010 <- bind_rows(Full_2007, Full_2010)

# Filter out different Subject values, order by Subject ID, and remove duplicates
Stacked_2007_2010 <- Stacked_2007_2010 %>%
  filter(!grepl("^[0-9]+$", subject)) %>% # filter out rows where the subject column contains a number. 
  filter(!grepl("\\.", subject)) %>% # filter out rows where the subject column contains a dot (.) 
  arrange(subject) %>% # Order the dataset by the subject column
  distinct(subject, .keep_all = TRUE) # Remove duplicates while keeping the first occurrence of each unique subject after filtering, keep_all = TRUE ensures that all columns are retained

```

# Stack Stacked_2007_2010 with Full_2000
```{r}
# Stack Stacked_2007_2010 with Full_2000
Stacked_2000_2007_2010 <- bind_rows(Stacked_2007_2010, Full_2000)
# Order by Subject, Remove duplicates
Stacked_2000_2007_2010 <- Stacked_2000_2007_2010 %>%
  arrange(subject) %>% # Orders the dataset by the subject column
  distinct(subject, .keep_all = TRUE) # remove duplicate rows

```

# Stack Stacked_2000_2007_2010 with Full_2016

```{r}
# Stack Stacked_2000_2007_2010 with Full_2016
Stacked_2000_2007_2010_2016 <- bind_rows(Stacked_2000_2007_2010, Full_2016)
# Order by Subject
Stacked_2000_2007_2010_2016 <- Stacked_2000_2007_2010_2016 %>%
  arrange(subject)  

# Make sure there are no duplicates:
any(duplicated(Stacked_2000_2007_2010_2016$subject))

```

# WRITE AS CBQ_Stacked.csv
```{r}
write.csv(Stacked_2000_2007_2010_2016, "/Users/aysuerdemir/Desktop/CBQ_EDA/CBQ_Stacked.csv")
```

