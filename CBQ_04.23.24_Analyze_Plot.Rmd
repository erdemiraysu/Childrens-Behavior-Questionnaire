---
title: "CBQ_04.23.24_Analyze_Plot"
output: html_document
date: "2024-04-29"
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(gridExtra) # for multiple bar graphs in a grid
```

# LOAD DATA
```{r}
# Load DataSet: 
CBQ_stacked <- read.csv(file = '/Users/aysuerdemir/Desktop/CBQ_EDA/CBQ_stacked.csv')
# Remove the added X variable after reading it back into R:
CBQ_stacked <- CBQ_stacked %>%
  dplyr::select(-X)
head(CBQ_stacked)
```
```{r}

# Define a function to calculate reversed values
subtract_eight <- function(x) {
8 - x
}

# Apply the function to columns cbq0001 through cbq0195
CBQ_stacked_r <- CBQ_stacked %>%
mutate(across(matches("^cbq0[01][0-9][0-9]$"), subtract_eight, .names = "{col}r"))

# Calculate the sub scales - create new variables
CBQ_scored <- CBQ_stacked_r %>%
mutate(
  act = rowMeans(dplyr::select(., cbq0001, cbq0025, cbq0041r, cbq0048, cbq0088r, cbq0102r, cbq0123r, cbq0126r, cbq0145r, cbq0152, cbq0172, cbq0187, cbq0192r), na.rm = TRUE),
  fru = rowMeans(dplyr::select(., cbq0002, cbq0019r, cbq0034, cbq0062, cbq0073, cbq0078, cbq0120r, cbq0128, cbq0140, cbq0156r, cbq0173, cbq0181, cbq0193), na.rm = TRUE),
  app = rowMeans(dplyr::select(., cbq0010, cbq0024, cbq0035, cbq0069, cbq0082, cbq0096, cbq0117, cbq0131r, cbq0148, cbq0166, cbq0175r, cbq0188r, cbq0191r), na.rm = TRUE),
  attfo = rowMeans(dplyr::select(., cbq0016, cbq0038r, cbq0047r, cbq0125, cbq0144, cbq0160, cbq0171r, cbq0186, cbq0195r), na.rm = TRUE),
  attshi = rowMeans(dplyr::select(., cbq0006r, cbq0029, cbq0095r, cbq0180, cbq0184r), na.rm = TRUE),
  dis = rowMeans(dplyr::select(., cbq0005r, cbq0021, cbq0061, cbq0087, cbq0097, cbq0101r, cbq0115, cbq0132, cbq0141, cbq0157, cbq0178, cbq0190r), na.rm = TRUE),
  sth = rowMeans(dplyr::select(., cbq0014r, cbq0027, cbq0042, cbq0053r, cbq0068r, cbq0085, cbq0092, cbq0103, cbq0118, cbq0134, cbq0150r, cbq0167r, cbq0177), na.rm = TRUE),
  fea = rowMeans(dplyr::select(., cbq0015r, cbq0040, cbq0050, cbq0058r, cbq0070r, cbq0080, cbq0091, cbq0130, cbq0138r, cbq0161r, cbq0176r, cbq0189), na.rm = TRUE),
  hip = rowMeans(dplyr::select(., cbq0008, cbq0022, cbq0030r, cbq0051r, cbq0060r, cbq0067, cbq0077, cbq0100, cbq0107, cbq0124, cbq0139, cbq0159r, cbq0182), na.rm = TRUE),
  imp = rowMeans(dplyr::select(., cbq0013, cbq0026, cbq0046, cbq0059, cbq0071r, cbq0079r, cbq0090r, cbq0104, cbq0114, cbq0137r, cbq0155, cbq0169r, cbq0183r), na.rm = TRUE),
  inh = rowMeans(dplyr::select(., cbq0004, cbq0020, cbq0032r, cbq0063, cbq0075, cbq0093r, cbq0108r, cbq0116, cbq0136, cbq0147, cbq0162r, cbq0168, cbq0185), na.rm = TRUE),
  lip = rowMeans(dplyr::select(., cbq0012r, cbq0036, cbq0054, cbq0066r, cbq0076,cbq0111r, cbq0113, cbq0133, cbq0146, cbq0151,cbq0164, cbq0174), na.rm = TRUE),
  per = rowMeans(dplyr::select(., cbq0009, cbq0028r, cbq0031, cbq0052, cbq0065,cbq0084r, cbq0098, cbq0105, cbq0122r, cbq0142r,cbq0154, cbq0170r), na.rm = TRUE),
  sad = rowMeans(dplyr::select(., cbq0018, cbq0039, cbq0044, cbq0055, cbq0064,cbq0072r, cbq0081, cbq0094, cbq0109r, cbq0112r,cbq0127, cbq0149r), na.rm = TRUE),
  shy = rowMeans(dplyr::select(., cbq0007, cbq0017r, cbq0023r, cbq0037,cbq0045r, cbq0057r, cbq0074, cbq0089, cbq0106,cbq0119r, cbq0129r, cbq0143, cbq0158r), na.rm = TRUE),
  smi =rowMeans(dplyr::select(., cbq0011, cbq0043r, cbq0056, cbq0083r,cbq0099r, cbq0110, cbq0121r, cbq0135r, cbq0152,cbq0163, cbq0165r, cbq0179, cbq0194), na.rm = TRUE)
)

# Rename the variables:
CBQ_scored <- CBQ_scored %>%
  mutate(shy_r=(8-shy)) %>%
  mutate(sth_r=(8-sth)) %>%
  rename(activity_level = act) %>%
  rename(anger_frustration = fru) %>%
  rename(approach = app) %>%
  rename(attention_focus = attfo) %>%
  rename(attention_shift = attshi) %>%
  rename(discomfort = dis) %>%
  rename(soothability = sth) %>%
  rename(fear = fea) %>%
  rename(hi_intense_pleas = hip) %>%
  rename(impulsivity = imp) %>%
  rename(inhibit_control = inh) %>%
  rename(lo_instense_pleas = lip) %>%
  rename(percept_sensitive = per) %>%
  rename(sadness = sad) %>%
  rename(shyness = shy) %>%
  rename(smiling_laughter = smi)

# Calculate the composite scores      
CBQ_scored <- CBQ_scored %>%
  mutate(surgency = rowMeans(dplyr::select(.,  activity_level,hi_intense_pleas, impulsivity, shy_r)),
         effortful_con = rowMeans(dplyr::select(.,  attention_focus, inhibit_control,lo_instense_pleas, percept_sensitive)),
         neg_affect = rowMeans(dplyr::select(.,  anger_frustration, discomfort,fear, sadness, sth_r))) 

# Filter to include only the scores not individual ratings. 
CBQ_scored <- CBQ_scored %>%
  dplyr::select(subject, age, gender, talkergroup, activity_level:neg_affect)
```

```{r}
# Give Age, Gender and Count Summary Statistics for each Group:
CBQ_age_gender_summary <- 
  CBQ_scored %>%
  group_by(talkergroup) %>%
summarise(
    age = mean(age, na.rm = TRUE),
    min_age = min(age, na.rm = TRUE),
    max_age = max(age, na.rm = TRUE),
    male_gender_count = sum(gender, na.rm = TRUE),  # because male = 1, female = 0
    SD_age = sd(gender, na.rm = TRUE),
    Count_kids = n_distinct(subject)
    )
print(CBQ_age_gender_summary)
```

# CREATE TWO HISTOGRAMS FOR AGE DISTRIBUTION IN CWS AND CWNS
```{r}

# Create a new plot
par(mfrow=c(1,2))  # This sets up a 1x2 grid for side-by-side histograms
# Histogram for talkergroup == 1
hist(CBQ_scored$age[CBQ_scored$talkergroup == 0], 
     main = "Histogram for CWNS",
     xlab = "age in months",
     ylab = "Frequency",
     col = "blue",
     border = "black",
     xlim = c(30, 100), 
     breaks = 12)
# Histogram for talkergroup == 2
hist(CBQ_scored$age[CBQ_scored$talkergroup == 1], 
     main = "Histogram for CWS",
     xlab = "age in months",
     ylab = "Frequency",
     col = "red",  # Use a different color for the second group
     border = "black",
     xlim = c(30, 100), 
     breaks = 12)
# Reset the plotting to a single plot
par(mfrow=c(1,1))
```

```{r}
# Drop the rows for when talkergroup is NA
CBQ_scored <- drop_na(CBQ_scored, talkergroup)

# Create a summary table for each scale, representing the means and SEMs for CWS and CWNS groups:

summary_cbq <- CBQ_scored %>%
  group_by(talkergroup) %>%
  summarise(across(c(age, activity_level, anger_frustration, approach, attention_focus, attention_shift, discomfort, soothability,
                     fear, hi_intense_pleas, impulsivity, inhibit_control, lo_instense_pleas, percept_sensitive, sadness, shyness,
                     smiling_laughter, surgency, effortful_con,neg_affect),
                   list(mean = ~mean(., na.rm = TRUE), SEM = ~sd(., na.rm = TRUE)/sqrt(n()))))%>%
  rename_all(~str_remove(., "_mean")) # remove the word mean from the mean measures for ease

# Rename talkergroup factors for better visuals:
summary_cbq$talkergroup <- factor(summary_cbq$talkergroup, levels = c(0, 1), labels = c("CWNS", "CWS"))
```


# BAR PLOTS
```{r}

# initialize an empty list
plots_list <- list()

# 
for (var in c("age", "activity_level", "anger_frustration", "approach", "attention_focus", "attention_shift", "discomfort", 
              "soothability", "fear",
              "hi_intense_pleas", "impulsivity", "inhibit_control", "lo_instense_pleas", "percept_sensitive", "sadness", "shyness",
              "smiling_laughter","surgency", "effortful_con","neg_affect")) {
  temp_plot <- ggplot(summary_cbq, aes(x = "talkergroup", y = var)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.5, fill ='royalblue2') +
    geom_errorbar(aes_string(ymin = paste0(var, " - ", var, "_SEM"), ymax = paste0(var, " + ", var, "_SEM")), width = 0.2, position = position_dodge(width = 0.7)) +
  labs(x = "TalkerGroup", y = var) +
    theme_minimal() +
    theme(plot.title = element_text(size=20), axis.title = element_text(size=16), axis.text = element_text(size=14))
  if (var == "age") {
    plots_list[[var]] <- temp_plot + coord_cartesian(ylim = c(40, 60))} 
  else {
      plots_list[[var]] <- temp_plot + coord_cartesian(ylim = c(3, 6))}
}

# use `coord_cartesian(ylim = c(3, 6))` instead of `scale_y_continuous(limits = c(3, 6))` to get the blue bars plotted correctly. 
# `coord_cartesian()` only affects the visible area of the plot and does not remove any data points, 
# while `scale_y_continuous()` removes data points outside the limits from the plot altogether.

# arrange the plots in a grid
cbq_plot <- grid.arrange(grobs = plots_list, ncol = 4, nrow = 5)

# save the plot as a PDF file with a width of 20 inches and a height of 15 inches
ggsave("cbq_plot.pdf", plot = cbq_plot, width = 20, height = 30)

```

